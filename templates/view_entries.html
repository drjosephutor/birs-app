{% extends "base.html" %}
{% block title %}View Tax Entries{% endblock %}
{% block content %}

<h2 class="mb-4">Submitted Tax Entries</h2>

<!-- Role-aware message and count -->
{% if current_user.role == 'ato' %}
  <div class="alert alert-info">
    Showing your submitted entries only.<br>
    <strong>Total submissions:</strong> {{ total_count }}
  </div>
{% elif current_user.role in ['admin', 'reviewer'] %}
  <div class="alert alert-info">
    Showing all ATO submissions across the platform.<br>
    <strong>Total entries:</strong> {{ total_count }}
  </div>
{% endif %}

<!-- Chart -->
<h4 class="mt-4">Tax Item Breakdown</h4>
<canvas id="taxChart" width="400" height="100"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('taxChart').getContext('2d');
  const taxChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [
        {% for item, count in tax_item_breakdown %}
          "{{ item }}"{% if not loop.last %},{% endif %}
        {% endfor %}
      ],
      datasets: [{
        label: 'Number of Entries',
        data: [
          {% for item, count in tax_item_breakdown %}
            {{ count }}{% if not loop.last %},{% endif %}
          {% endfor %}
        ],
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>

<!-- Filter Form -->
<form method="GET" class="row mb-4">
  <div class="col-md-4">
    <label for="tax_item">Filter by Tax Item:</label>
    <select name="tax_item" class="form-select">
      <option value="">All</option>
      <option value="PAYE" {% if tax_item == 'PAYE' %}selected{% endif %}>PAYE</option>
      <option value="Withholding" {% if tax_item == 'Withholding' %}selected{% endif %}>Withholding</option>
      <option value="Development" {% if tax_item == 'Development' %}selected{% endif %}>Development Levy</option>
      <option value="Road" {% if tax_item == 'Road' %}selected{% endif %}>Road Taxes</option>
    </select>
  </div>
  <div class="col-md-4">
    <label for="date">Filter by Date:</label>
    <input type="date" name="date" class="form-control" value="{{ date_filter }}">
  </div>
  <div class="col-md-4 d-flex align-items-end">
    <button type="submit" class="btn btn-primary">Apply Filters</button>
  </div>
</form>

<!-- Entries Table -->
<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th>S/N</th>
      <th>Tax Item</th>
      <th>Subhead</th>
      <th>ATO</th>
      <th>Entry Date</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody>
    {% for entry in entries %}
    <tr>
      <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
      <td>{{ entry.tax_item }}</td>
      <td>{{ entry.subhead or '—' }}</td>
      <td>{{ entry.user.username }}</td>
      <td>{{ entry.date_uploaded.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>
        Remita: {% if entry.rrr_verified %}✅ ₦{{ entry.rrr_amount }}{% else %}❌{% endif %}<br>
        PayDirect: {% if entry.paydirect_verified %}✅ ₦{{ entry.paydirect_amount }}{% else %}❌{% endif %}

        <form method="POST" action="{{ url_for('reverify_entry', entry_id=entry.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-sm btn-warning mt-2">Verify Now</button>
        </form>
        <button class="btn btn-sm btn-info mt-2" onclick="toggleDetails('{{ loop.index }}')">View</button>
        {% if not entry.rrr_verified and not entry.paydirect_verified %}
          <form method="POST" action="{{ url_for('delete_entry', entry_id=entry.id) }}" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-danger mt-2" onclick="return confirm('Delete this unverified entry?')">Delete</button>
          </form>
        {% endif %}

        <div id="details-{{ loop.index }}" style="display:none; margin-top:10px;">
          {% if entry.data %}
          <ul>
            {% for key, value in entry.data.items() %}
              {% if key != 'csrf_token' %}
                <li><strong>{{ key.replace('_', ' ').title() }}:</strong> {{ value }}</li>
              {% endif %}
            {% endfor %}

          </ul>
          {% else %}
          <p>No details available.</p>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if pagination.has_prev %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('view_entries', page=pagination.prev_num, tax_item=tax_item, date=date_filter) }}">Previous</a>
    </li>
    {% endif %}
    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('view_entries', page=page_num, tax_item=tax_item, date=date_filter) }}">{{ page_num }}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
    {% endfor %}
    {% if pagination.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('view_entries', page=pagination.next_num, tax_item=tax_item, date=date_filter) }}">Next</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
  function toggleDetails(index) {
    const el = document.getElementById('details-' + index);
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }
</script>

<a href="{{ url_for('dashboard') }}" class="btn btn-secondary mt-4">← Back to Dashboard</a>
{% endblock %}




